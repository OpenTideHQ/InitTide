UUID,Name,Type,Tlp,Description,Version,Created,Modified,Childs,Parents,Chaining,Threat Actors,ATT&CK
bdc58fee-8da6-4fc9-8fbd-30f8fd156bc7,Powershell with encoded payload passed to cmdline,Threat Vectors,clear,"When working with PowerShell, a threat actor can encode a command or script
using Base64 or other type of encoding and pass it as a parameter to the
command line. This technique is useful for obfuscating sensitive
information or executing complex commands. (ref [1])  

Other possible examples for encoding with PowerShell commands: 

Encoding a Command with Base64

1. Create a command as a string. 

```
$command = 'dir ""C:\Program Files""'
```

2. Convert the command to Base64:

```pwsh
$bytes = [System.Text.Encoding]::Unicode.GetBytes($command)
$encodedCommand = [Convert]::ToBase64String($bytes)
```

Now you can run the encoded command using powershell.exe:

```
powershell.exe -encodedCommand $encodedCommand
```

It's also possible to encode domain names, for example: 

Powershell input:

```pwsh
[Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes(""'sample_domain.com'""))
```

Threat actors also use PowerShell scripts for faster encoding process and result.  

An example of Powershell script (ref [2])  

```pwsh
param(
[Parameter()][Alias(""un"")][string]$Username,
[Parameter()][Alias(""pw"")][string]$Password
)

Write-Host ""Username: $Username""
Write-Host ""Password: $Password""
```",1,2024-04-23,2024-04-24,cf9c69a2-9317-4f0f-9506-fbeeb1c73ff0,,,"APT28, APT27","T1027.010, T1059, T1059.001, T1140, T1068"
cf9c69a2-9317-4f0f-9506-fbeeb1c73ff0,Powershell encoded payload to start new process,Detection Models,clear,"Adversaries use PowerShell to execute local scripts and execute remote resources 
after retrieving them using multiple network protocols. They can also encode payloads 
using the command line and load PowerShell into other processes.

Here are some examples of encoded PowerShell payloads and how they can be detected:

### Base64-Encoded Payload

#### background

A common technique is to encode the entire PowerShell script in Base64 and execute it using 
the -encodedcommand switch.

To detect this, look for:
- Execution of powershell.exe with encode arguments
- The presence of base64 string in the command line

#### detection strategies

to detect base64encoded string, you may use REGEX and then you may have the 
option on the detection platform to decode the base64 encoded string to 
confirm the actions done.  

When focusing on specific keywords within the encoded string, a very good
approach is to precompute the base64 encoded version of the keyword and 
search for that pattern in strings. To precompute the base64 string, 3 
scenario have to be considered:
- the keyword is at a boundary of a 3-character block
- the keyword starts at second character of a 3-character block
- the keyword starts at the third character of 3-character block

Malicious payloads are often encoded and obfuscated, with PowerShell commands frequently 
used to download them from the internet. To detect encoded and downloadable command line 
arguments, it is essential to examine PowerShell logs, such as Sysmon or Windows PowerShell logs, 
for the presence of specific keywords like ""Net.WebClient,"" ""DownloadFile,"" ""Invoke-WebRequest,"" 
""Invoke-Shellcode,"" ""http:,"" ""-enc,"" ""-encodedCommand,"" ""-e,"" ""-ec,"" ""-en,"" ""-encod,"" and ""-enco"".  

Additionally, you can visit the following page to access a PowerShell Watchlist that helps with detection. [4]  

For example, this CDM attemtps to detect the launch of a process 
using the cmdlet ""Start-Process"". Preprocessing this keyword gives 
the following search strings (without decoding base64 nor REGEX)

| Keyword | offset | string (with leading _ or *) | search string |
| --- | --- | --- | --- |
| Start-Process | 0 | U3RhcnQtUHJvY2Vzcw== | U3RhcnQtUHJvY2Vz |
| Start-Process | 1 | X1N0YXJ0LVByb2Nlc3M= / KlN0YXJ0LVByb2Nlc3M= | N0YXJ0LVByb2Nl |
| Start-Process | 2 | X19TdGFydC1Qcm9jZXNz / KipTdGFydC1Qcm9jZXNz | TdGFydC1Qcm9jZXNz |
    
### Obfuscated Payload with Special Characters

Adversaries may also obfuscate the PowerShell script using special characters.

To detect this, look for:
- Execution of powershell.exe with the -nop, -w hidden, and -c arguments
- High counts of obfuscation characters like `, `, and '

Useful telemetry will include:

- Windows Security Event ID 400: PowerShell command-line logging
- Windows Security Event IDs 800 and 4103: Module loading and Add-Type logging
- Windows Security Event ID 4688 : A new process has been created including process command-line
- Sysmon Event IDs 1 and 7: Process creation and Image loaded
",2,2024-04-26,2025-01-10,0be66eea-4ae4-4544-811b-52651e20d744,bdc58fee-8da6-4fc9-8fbd-30f8fd156bc7,,,
0be66eea-4ae4-4544-811b-52651e20d744,RBA_RR - WIN base64 encoded powershell payload,Detection Rules,clear,"Detect base64 encoded PowerShell payload that could be used to launch 
a process or a script.
The detection applies up to 2 levels of encoded payload (a first payload 
containing a PowerShell command with a second base64 payload).  

### Splunk(Sentinel) investigation guidelines ###

The alert notification contains
- host(src_host): the host on which the process was launched.
- src_user: the account used.
- ParentProcessName(parent_process): the process launching the PS with base64 payload.
- NewProcessName(process): PS.
- CommandLine(command_line): the original command line as seen in logs.
- payload_b64_ascii [and payload_b64]: the first level of encoded payload. 
They are always present.
- payload_level2_b64_ascii [and payload_level2_b64] may also be provided 
if the first level was containing another base64 encoded payload.
For Sentinel Alert, you have to decode the base64 string present in command_line field,
using CyberChef or any base64 decoding tool.  

### SENTINEL alerts triage ###
CATCH uses TIDE_LD_005_CSIRC_WL_Win_Base64_Encoded_PS_Payload.csv
to filter legitimate or benign base64 encoded payloads used by PowerShell 
on EC Windows devices running on our Azure IaaS & PaaS tenant.

### ES-SPLUNK alerts triage ###
CATCH uses SOC_LT_289_WIN_reviewed_base64_encoded_payload-exclude.csv
to filter legitimate or benign base64 encoded payloads used by PowerShell 
on EC Windows devices.
",6,2024-05-16,2025-01-09,,cf9c69a2-9317-4f0f-9506-fbeeb1c73ff0,,,
