{
    "tvm": {
        "metadata": {
            "field": "tvm",
            "icon": "\u2623\ufe0f",
            "name": "Threat Vectors",
            "description": "Threat Vectors",
            "model": true
        },
        "entries": {
            "bdc58fee-8da6-4fc9-8fbd-30f8fd156bc7": {
                "name": "Powershell with encoded payload passed to cmdline",
                "model": true,
                "tlp": "clear",
                "criticality": "Medium",
                "description": "When working with PowerShell, a threat actor can encode a command or script\nusing Base64 or other type of encoding and pass it as a parameter to the\ncommand line. This technique is useful for obfuscating sensitive\ninformation or executing complex commands. (ref [1])  \n\nOther possible examples for encoding with PowerShell commands: \n\nEncoding a Command with Base64\n\n1. Create a command as a string. \n\n```\n$command = 'dir \"C:\\Program Files\"'\n```\n\n2. Convert the command to Base64:\n\n```pwsh\n$bytes = [System.Text.Encoding]::Unicode.GetBytes($command)\n$encodedCommand = [Convert]::ToBase64String($bytes)\n```\n\nNow you can run the encoded command using powershell.exe:\n\n```\npowershell.exe -encodedCommand $encodedCommand\n```\n\nIt's also possible to encode domain names, for example: \n\nPowershell input:\n\n```pwsh\n[Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes(\"'sample_domain.com'\"))\n```\n\nThreat actors also use PowerShell scripts for faster encoding process and result.  \n\nAn example of Powershell script (ref [2])  \n\n```pwsh\nparam(\n[Parameter()][Alias(\"un\")][string]$Username,\n[Parameter()][Alias(\"pw\")][string]$Password\n)\n\nWrite-Host \"Username: $Username\"\nWrite-Host \"Password: $Password\"\n```"
            }
        }
    },
    "cdm": {
        "metadata": {
            "field": "cdm",
            "icon": "\ud83d\udee1\ufe0f",
            "name": "Detection Models",
            "description": "Detection Models",
            "model": true
        },
        "entries": {
            "cf9c69a2-9317-4f0f-9506-fbeeb1c73ff0": {
                "name": "Powershell encoded payload to start new process",
                "model": true,
                "tlp": "clear",
                "criticality": "High",
                "description": "Adversaries use PowerShell to execute local scripts and execute remote resources \nafter retrieving them using multiple network protocols. They can also encode payloads \nusing the command line and load PowerShell into other processes.\n\nHere are some examples of encoded PowerShell payloads and how they can be detected:\n\n### Base64-Encoded Payload\n\n#### background\n\nA common technique is to encode the entire PowerShell script in Base64 and execute it using \nthe -encodedcommand switch.\n\nTo detect this, look for:\n- Execution of powershell.exe with encode arguments\n- The presence of base64 string in the command line\n\n#### detection strategies\n\nto detect base64encoded string, you may use REGEX and then you may have the \noption on the detection platform to decode the base64 encoded string to \nconfirm the actions done.  \n\nWhen focusing on specific keywords within the encoded string, a very good\napproach is to precompute the base64 encoded version of the keyword and \nsearch for that pattern in strings. To precompute the base64 string, 3 \nscenario have to be considered:\n- the keyword is at a boundary of a 3-character block\n- the keyword starts at second character of a 3-character block\n- the keyword starts at the third character of 3-character block\n\nMalicious payloads are often encoded and obfuscated, with PowerShell commands frequently \nused to download them from the internet. To detect encoded and downloadable command line \narguments, it is essential to examine PowerShell logs, such as Sysmon or Windows PowerShell logs, \nfor the presence of specific keywords like \"Net.WebClient,\" \"DownloadFile,\" \"Invoke-WebRequest,\" \n\"Invoke-Shellcode,\" \"http:,\" \"-enc,\" \"-encodedCommand,\" \"-e,\" \"-ec,\" \"-en,\" \"-encod,\" and \"-enco\".  \n\nAdditionally, you can visit the following page to access a PowerShell Watchlist that helps with detection. [4]  \n\nFor example, this CDM attemtps to detect the launch of a process \nusing the cmdlet \"Start-Process\". Preprocessing this keyword gives \nthe following search strings (without decoding base64 nor REGEX)\n\n| Keyword | offset | string (with leading _ or *) | search string |\n| --- | --- | --- | --- |\n| Start-Process | 0 | U3RhcnQtUHJvY2Vzcw== | U3RhcnQtUHJvY2Vz |\n| Start-Process | 1 | X1N0YXJ0LVByb2Nlc3M= / KlN0YXJ0LVByb2Nlc3M= | N0YXJ0LVByb2Nl |\n| Start-Process | 2 | X19TdGFydC1Qcm9jZXNz / KipTdGFydC1Qcm9jZXNz | TdGFydC1Qcm9jZXNz |    \n### Obfuscated Payload with Special Characters\n\nAdversaries may also obfuscate the PowerShell script using special characters.\n\nTo detect this, look for:\n- Execution of powershell.exe with the -nop, -w hidden, and -c arguments\n- High counts of obfuscation characters like `, `, and '\n\nUseful telemetry will include:\n\n- Windows Security Event ID 400: PowerShell command-line logging\n- Windows Security Event IDs 800 and 4103: Module loading and Add-Type logging\n- Windows Security Event ID 4688 : A new process has been created including process command-line\n- Sysmon Event IDs 1 and 7: Process creation and Image loaded\n"
            }
        }
    },
    "dom": {
        "metadata": {
            "field": "dom",
            "icon": "\ud83c\udfaf",
            "name": "Detection Objectives",
            "description": "Detection Objectives",
            "model": true
        },
        "entries": {
            "cf9c69a2-9317-4f0f-9506-fbeeb1c73ff0": {
                "name": "Powershell encoded payload to start new process",
                "model": true,
                "tlp": "clear",
                "criticality": "High",
                "description": "Adversaries use PowerShell to execute local scripts and execute remote resources \nafter retrieving them using multiple network protocols. They can also encode payloads \nusing the command line and load PowerShell into other processes.\n\nHere are some examples of encoded PowerShell payloads and how they can be detected:\n\n### Base64-Encoded Payload\n\n#### background\n\nA common technique is to encode the entire PowerShell script in Base64 and execute it using \nthe -encodedcommand switch.\n\nTo detect this, look for:\n- Execution of powershell.exe with encode arguments\n- The presence of base64 string in the command line\n\n#### detection strategies\n\nto detect base64encoded string, you may use REGEX and then you may have the \noption on the detection platform to decode the base64 encoded string to \nconfirm the actions done.  \n\nWhen focusing on specific keywords within the encoded string, a very good\napproach is to precompute the base64 encoded version of the keyword and \nsearch for that pattern in strings. To precompute the base64 string, 3 \nscenario have to be considered:\n- the keyword is at a boundary of a 3-character block\n- the keyword starts at second character of a 3-character block\n- the keyword starts at the third character of 3-character block\n\nMalicious payloads are often encoded and obfuscated, with PowerShell commands frequently \nused to download them from the internet. To detect encoded and downloadable command line \narguments, it is essential to examine PowerShell logs, such as Sysmon or Windows PowerShell logs, \nfor the presence of specific keywords like \"Net.WebClient,\" \"DownloadFile,\" \"Invoke-WebRequest,\" \n\"Invoke-Shellcode,\" \"http:,\" \"-enc,\" \"-encodedCommand,\" \"-e,\" \"-ec,\" \"-en,\" \"-encod,\" and \"-enco\".  \n\nAdditionally, you can visit the following page to access a PowerShell Watchlist that helps with detection. [4]  \n\nFor example, this CDM attemtps to detect the launch of a process \nusing the cmdlet \"Start-Process\". Preprocessing this keyword gives \nthe following search strings (without decoding base64 nor REGEX)\n\n| Keyword | offset | string (with leading _ or *) | search string |\n| --- | --- | --- | --- |\n| Start-Process | 0 | U3RhcnQtUHJvY2Vzcw== | U3RhcnQtUHJvY2Vz |\n| Start-Process | 1 | X1N0YXJ0LVByb2Nlc3M= / KlN0YXJ0LVByb2Nlc3M= | N0YXJ0LVByb2Nl |\n| Start-Process | 2 | X19TdGFydC1Qcm9jZXNz / KipTdGFydC1Qcm9jZXNz | TdGFydC1Qcm9jZXNz |    \n### Obfuscated Payload with Special Characters\n\nAdversaries may also obfuscate the PowerShell script using special characters.\n\nTo detect this, look for:\n- Execution of powershell.exe with the -nop, -w hidden, and -c arguments\n- High counts of obfuscation characters like `, `, and '\n\nUseful telemetry will include:\n\n- Windows Security Event ID 400: PowerShell command-line logging\n- Windows Security Event IDs 800 and 4103: Module loading and Add-Type logging\n- Windows Security Event ID 4688 : A new process has been created including process command-line\n- Sysmon Event IDs 1 and 7: Process creation and Image loaded\n"
            }
        }
    },
    "bdr": {
        "metadata": {
            "field": "bdr",
            "icon": "\ud83c\udfdb\ufe0f",
            "name": "Business Requests",
            "description": "Business Requests",
            "model": true
        },
        "entries": {}
    },
    "mdr": {
        "metadata": {
            "field": "mdr",
            "icon": "\ud83d\udea8",
            "name": "Detection Rules",
            "description": "Detection Rules",
            "model": true
        },
        "entries": {
            "0be66eea-4ae4-4544-811b-52651e20d744": {
                "name": "RBA_RR - WIN base64 encoded powershell payload",
                "model": true,
                "tlp": "clear",
                "description": "Detect base64 encoded PowerShell payload that could be used to launch \na process or a script.\nThe detection applies up to 2 levels of encoded payload (a first payload \ncontaining a PowerShell command with a second base64 payload).  \n\n### Splunk(Sentinel) investigation guidelines ###\n\nThe alert notification contains\n- host(src_host): the host on which the process was launched.\n- src_user: the account used.\n- ParentProcessName(parent_process): the process launching the PS with base64 payload.\n- NewProcessName(process): PS.\n- CommandLine(command_line): the original command line as seen in logs.\n- payload_b64_ascii [and payload_b64]: the first level of encoded payload. \nThey are always present.\n- payload_level2_b64_ascii [and payload_level2_b64] may also be provided \nif the first level was containing another base64 encoded payload.\nFor Sentinel Alert, you have to decode the base64 string present in command_line field,\nusing CyberChef or any base64 decoding tool.  \n\n### SENTINEL alerts triage ###\nCATCH uses TIDE_LD_005_CSIRC_WL_Win_Base64_Encoded_PS_Payload.csv\nto filter legitimate or benign base64 encoded payloads used by PowerShell \non EC Windows devices running on our Azure IaaS & PaaS tenant.\n\n### ES-SPLUNK alerts triage ###\nCATCH uses SOC_LT_289_WIN_reviewed_base64_encoded_payload-exclude.csv\nto filter legitimate or benign base64 encoded payloads used by PowerShell \non EC Windows devices.\n"
            }
        }
    }
}